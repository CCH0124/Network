# Cross-Site Request Forgery
Cross-site request forgery（跨站點請求偽造）攻擊會誘使受害者使用其認證來調用狀態更改活動。

## What is Cross-Site Request Forgery (CSRF) ?
跨站點請求偽造攻擊是一種混亂的代理網路攻擊，欺騙用戶意外使用其認證來調用狀態更改活動，例如：從其帳戶轉移資金、更改其電子郵件地址和密碼，或其他一些不受歡迎的行動。

雖然對常規用戶的潛在影響很大，但對管理帳戶的成功，CSRF 攻擊可能會危及整個服務器，從而可能導致完全接管 Web 應用程序、API 或其它服務。

## How does Cross-Site Request Forgery Work ?
此攻擊側重於定位狀態更改請求，該請求指的是導致數據從一個值更改為另一個值的請求類型。
例如，目標請求可能會購買或更改帳戶中的值。有趣的是，這是一次"盲目攻擊"，並沒有將數據返回給攻擊者，使其成為數據竊取的不良選擇。

跨站點請求偽造攻擊的 4 個步驟的示例：
1. 攻擊者創建一個偽造的請求，在運行時，將從特定銀行轉移 10,000 美元到攻擊者的帳戶。
2. 攻擊者將偽造的請求嵌入到超鏈接中，並透過批量電子郵件發送出去，並將其嵌入到網站中。
3. 受害者點擊攻擊者放置的電子郵件或網站鏈接，導致受害者向銀行請求轉移 10,000 美元。
4. 銀行服務器接收請求，並且由於受害者得到適當授權，它將請求視為合法並轉移資金。

![](https://www.cloudflare.com/img/learning/security/threats/cross-site-request-forgery/forged-request.png)

CSRF 攻擊的方法不同，但通常具有以下特徵：
1. 他們利用依賴用戶身份的網站
2. 他們欺騙用戶的瀏覽器向目標站點發送 HTTP 請求
3. 它們涉及使用具有副作用且沒有適當的 CSRF 保護的 HTTP 請求

不同的 HTTP 動詞（POST、GET、PUT等）對 CSRF 攻擊具有不同的易受攻擊性，從而導致可變保護策略。這是由於 Web 瀏覽器以不同方式處理動詞的方式。

HTTP GET 請求具有嵌入的參數，例如：圖像標記內的參數，可以對其進行操作和利用。通常，GET 請求不會修改狀態，使其無法作為正確實現的 Web 應用程序或其他資源的 CSRF 的目標。

HTTP POST 用於更改狀態，從而增加了對保護的需求。為此，Web 瀏覽器實現稱為相同源策略（SOP）和跨源資源共享（CORS）的安全措施，其包含跨源安全策略。SOP 僅允許來自同一來源的請求，並且 CORS 僅允許來自不同來源的某些類型的請求。這些實現的組合通過限制請求或網頁與不同來源交互的能力來幫助防止CSRF 攻擊（以及其他）。

其他 HTTP 動詞（PUT 和 DELETE）只能使用 SOP 和 CORS 運行，從而減輕了許多跨站點攻擊。

雖然這種情況並不常見，但有些網站會明確禁用這些安全措施，並且可以在網路瀏覽器中禁用它們。

## How can Cross-Site Request Forgery be mitigated ?
減輕 CSRF 攻擊的最常用方法是使用兩種方法之一使用 Anti-CSRF tokens。雖然 token 實現略有不同，但基本原理保持不變，透過創建然後比較隨機生成的 token 字符串，攻擊者不太可能在沒有極不可能的猜測的情況下執行攻擊。

##### Synchronizer token pattern
當用戶訪問網頁時，例如：允許轉移資金的銀行網頁，銀行的網站會在表單中嵌入隨機 token 。當用戶提交表單時，返回隨機 token，銀行可以檢查兩個 token 是否匹配，如果 token 匹配，則發生轉移。攻擊者無法訪問在網頁中創建的隨機令 token，如果他們請求頁面，則相同的源策略將阻止攻擊者讀取響應。

這種方法緩解的缺點是它增加了服務器端的負擔，以檢查每個請求的令牌的有效性。如果用戶有多個瀏覽器窗口或涉及發出請求的不同軟體的其它條件，它也可能會產生問題。**透過將 token 的範圍擴展為每個會話而不是每個請求，可以避免一些這種困難**。

##### Cookie-to-header token
另一種方法是向訪問者的 Web 瀏覽器發出一個包含隨機 token 的 cookie。 在客戶端運行的 JavaScript 將讀取 cookie 中 token 的值，並將其複製到將隨每個請求一起發送的 HTTP header 中。如果從用戶發送了真實請求，則可以由服務器驗證標頭中的值。任何其他實例都將失敗，從而減輕攻擊成功。

通過 WAF 使用自定義規則，用戶可以幫助防止某些 CSRF 攻擊。

## Confused Deputy problem
一個責任混淆（Confused Deputy）指的是一個被濫用其權威的計算機程序。與此類漏洞相關的風險是基於功能的安全性有助於降低與濫用相關的風險的原因。例如，在安裝軟體時，今天大多數計算機都要求用戶登錄。這有助於防止在用戶意外使用其權限授權安裝時無意中執行代碼。

## Ref
[IThome](https://www.ithome.com.tw/voice/115822)
[Confused Deputy problem](https://en.wikipedia.org/wiki/Confused_deputy_problem)